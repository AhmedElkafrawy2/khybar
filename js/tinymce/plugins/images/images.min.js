var files;
tinymce.PluginManager.add('images', function(editor, url) {
  // Add a button that opens a window
  editor.addButton('images', {
    text: 'تحميل اكثر من صورة',
    icon: false,
    onclick: function() {
      // Open window
      editor.windowManager.open({
        title: 'برجاء اختيار الصور',
        body: [
          { 
            type     : 'textbox',
            name     : 'file',
            subtype  : 'file',
            label    : 'Upload',
            multiple : 'multiple',
            id       :  'mutli-file',
            onchange : function(e){
                var data = e.target.files;
                $.each(data , function(k,value){
                   if(value.type == "image/png" || value.type == "image/jpg" || value.type == "image/jpeg"){
                       files = e.target.files;
                   }else{
                        $("#mutli-file").val("");
                        tinymce.activeEditor.windowManager.alert('برجاء اختيار صورة');
                   }
                });
                
            }
          }
        ],
        onsubmit: function(e) {
                var data = new FormData();
                var _token = $('meta[name="csrf-token"]').attr('content');
                var number = "";
                data.append("_token" , _token);
                $.each(files , function(k,v){
                    data.append(k,v);
                    number = k;
                });
                data.append("number" , number);
                var url = $("#upload-image").val();
                $.ajax({

                    url  : url,
                    type : "POST",
                    data: data,
                    contentType: false,
                    processData: false,
                    beforeSend: function() {
                        $(".loading").css("display" , "block");
                        $("body").css("overflow-y" , "hidden");
                    },
                    success :function(data){
                        $.each(data , function(k,v){
                            $.each(v,function(m,n){
                                tinyMCE.execCommand('mceInsertContent',false,'<p><img src="'+n+'"/></p>');
                                $(".loading").css("display" , "none");
                                $("body").css("overflow-y" , "auto");
                            })
                        });
                    },
                    error:function(error){
                        console.log("error" , error);
                    }
                 });
        }
      });
    }
  });

});
